# 第六节 主从库如何实现数据一致

redis 除了通过持久化来避免数据少丢失保证高可靠性，还通过增加副本方式，保证数据可靠。

### 主从如何同步？

1、首次连接从库，会全量复制

2、期间通过长连接，将写命令同步给从库

3、断网重连后，real_backlog_buffer 记录的主从库读写位置，增量复制数据到从库

4、断网时间过长，导致real_balcklog_buffer 写命令位置覆盖读的进度，会再次触发全量复制

### 1、全量复制是如何进行的？

首先，同步动作是由从库发起的，从库会发生 psync 告知主库，需要进行同步数据，该命令包含了主库的 runId 和复制进度；

redis 主库是如何判断全量复制还是增量复制的呢？

1、判断runId，当从库传递的 runId 与主库不一致，就触发全量复制

2、判断复制进度，当从库传递的复制进度在主库中不存在，就触发全量复制

当触发全量复制时，主库就是返回 fullresync 命令，包含了当前主库的  runId 和主库记录的复制进度（从库会记录下这两个数据）；

之后，主库会启用 bgsave ，生成 RDB 全量文件，并将文件发给从库；从库为避免其他数据干扰，会将自身数据情况，读取 RDB 文件；

主从同步不会阻塞主库接收请求，因此如果 RDB 后有些命令，主库会将这些命令记录到专门的缓冲区中（replication buffer），缓冲区的命令会在 RDB 文件发送完成后，由主库发送给从库，从库会一一执行这些操作。

### 2、基于长连接的命令同步

处于性能考虑，需要避免频繁主从建立连接，因此完成全量复制后，主从会一直保持一个连接，通过这个连接将后续写命令同步给从库

### 3、断网重连后，数据如何同步

主从连接后，从库会发送ack信号，主库根据这个信号判断与从库的连接情况，当距上一次接收的信号时间超过规定时间就会认为与从库断开了连接。

那断网重连后如何同步呢

这里就用到了复制进度，主库记录的是写的位置，从库记录的是读的进度；

主从最开始连接时，读写位置一起，当主库处理写请求时，记录的写位置会前移，而当从库正常同步时，从库消化写命令，记录的读位置也会前移直到追到主库，即正常同步时，主从记录的位置是一致；

当断网后，主库写位置正常移动，从库读位置不动，因此，重新连接后，主库把两个位置之间的写命令同步给从库即可

redis 使用了一个环形缓冲区来记录读写位置，因此，缓冲区满后，还会继续写入，当有突发请求从库来不及同步或断网时间过长时，主库的写命令可能会将未读取的写命令给覆盖了。如果主库发现从库的复制进度被覆盖了，就会触发全量复制，避免数据同步不一致。

对于突发请求导致的全量复制，可以通过增加缓冲区空间大小解决，空间大小可以通过 【主库写入速度 * 命令大小 - 主从命令传输速度  * 命令大小】来计算，实际大小可以在此基础上 *2。