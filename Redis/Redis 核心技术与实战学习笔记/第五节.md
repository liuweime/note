# 第五节 redis 如何实现快速恢复

### 1、RDB是什么

RDB 是redis 两种持久化方式之一，将内存的数据落到磁盘中，形成一个快照，在恢复数据时就避免了 AOF 需要重新执行的问题，可以直接加载到内存中，达到快速恢复的目的

### 2、快照是如何进行的？

为保证数据可靠性，进行的是全量快照。redis 提供了两种方式来进行快照，分表是 save 和 bgsave。

其中save命令在主线程中执行，在执行时会阻塞主线程；bgsave命令会fork一个子线程来完成RDB。

### 3、快照时数据变动怎么办

与 AOF fork 子线程写日志一样，RDB fork的子线程在 RDB时也会遇到主线程执行写命令的情况，为避免快照数据异常，redis 使用了写时复制，因为子线程共享付线程的内存数据，在RDB时如果主线程有写入操作，会将这部分数据同样写入RDB文件中

### 4、如何保证快照高效可靠

快照保存的是某一个时刻的内存数据，如果在两个时刻之间产生宕机，两个时刻之间的数据就会丢失；当两个时刻间隔越小时，丢失的数据就越少

但是频繁的RDB会带来性能问题：

1、会频繁的写入磁盘，造成磁盘压力很大，极小的间隔可能会导致上次快照还未写完，下一次又开始了；

2、fork 子线程时会阻塞主线程，这个阻塞时间与主线程内存大小成正相关

因此和AOF类似，如果使用RDB快照方式持久化，也需要根据实际来选择快照的时间

### 5、是否做的既快速恢复又较小开销少丢数据呢

可以使用混合AOF、RDB的方式进行持久化。每次RDB 记录全量数据，两次RDB之间使用 AOF记录增量数据；在第二次RDB时，就可将AOF文件清空

如果故障发生在两次RDB之间，就可以将第一次RDB数据和AOF文件结合恢复数据

这样合适的时间间隔，避免了频繁写磁盘和阻塞主线程，两次RDB的数据由可以通过AOF来恢复，而两次时间间隔的AOF文件也不会太大，恢复起来速度很快，也避免了AOF重写开销。