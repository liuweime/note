# 第七节 哨兵机制

启用主从模式后，当主库挂掉，无论是数据同步还是写操作均无法进行，大大影响可用性，需要哨兵模式来重新选出一个主库来提供服务。

1、哨兵机制的基本流程

- 监控

  哨兵会监控所有主从库连接状态，通过发送 ping 检测，当主从没有在规定时间响应，就会被标记成[下线状态]；这个规定时间由参数`down-after-milliseconds`控制

- 选主

  当主库被标记为下线状态后，就会开始切换主库，哨兵会在在线从库中选择出一个作为新的主库

- 通知

  完成主库选择后，哨兵会通知在线从库与主库建立连接，执行数据复制；哨兵会告知客户端新主库的连接信息

2、哨兵是如何判断主库下线了

主库下线会导致对外服务间断，主从切换也会带来不必要的开销，需要慎重，为避免哨兵误判，通常使用多个哨兵同时判断，对下线判断少数服从多数。

主观下线与客户下线

单个哨兵监控发现主库没有响应，会将主库标记为主观下线，当多数哨兵均标记这个主库为主观下线后，这个主库被标记成功客观下线，启动主从切换

3、如何选出新主库

并不是所有从库都有资格成为从库，黑历史多的从库会被首选放弃，这里的黑历史就是从库经常与主库断连，显然这种从库的网络情况不是很好，就不适合成为主库。

剩余的从库，哨兵会根据优选级配置、复制进度、从库ID 号来给从库打分，分数最后的被选举为主库

- 优先级配置

  通过从库的`slave-priority`来配置优先级，优先级高的从库会被打高分，哨兵会直接选举这个从库为主库

- 复制进度

  复制进度高的从库说明和主库数据最为接近，那么这个从库会被选举为主库

- 从库ID

  在上面从此后，如果得分还是一样，哨兵就是取从库ID最小的作为主库

4、哨兵集群是如何主从切换的

哨兵集群下会选举出一个leader处理主从切换，这个选举采用** Raft 算法**

4、问题

**哨兵启动主从切换时，redis 还能对外提供服务吗，如果想主从切换要业务无感知，应该怎么做**

答：自动进行主从切换时，redis 对外读服务大部分正常，写服务不可用；切换时未同步到从库的新写数据，无法正常读，更新的数据会返回旧值；

客户端需要订阅主从切换相关频道，当收到主库下线事件，就将写命令放入消息队列中，当收到收到通知新主库地址后，重放这些命令