# Redis 学习 | 主从同步

### 主从同步如何进行

- 由从库发送同步请求，主库接收到后触发 bgsave 生成 RDB 文件传递给从库
- RDB 生成后的写命令被主库保存在缓冲区，在 RDB 传递完成后同步给从库
- 全量同步完成后，主从不会断开连接，而维持了一个长连接用于同步写命令

### 主从同步原理

接收到从库请求后，主库动作：

- 从库发送请求：主从首次连接后，从库发送 psync 命令，该命令附加了 runId 和从库复制进度，runId 在首次时是？；
- 全量复制 or 增量复制：满足以下两种情况，触发全量复制，全量复制后，主库发送 fullresync 给从库，该命令包含了主库的 runId和主库记录的复制进度
  - 主库发现 runId 与自身的 runId 不一致
  - 发现发送从库的复制进度不在复制缓冲区中
- bgsave：发送 fullresync 后，主库就会触发 bgsave，生成 RDB 文件发送给从库
- 增量命令：RDB 后的写命令会被写入 replication buffer 中，当 RDB 发送完成后，将缓冲区内容发送给从库
- 保持连接：为避免主从同步频繁建立连接，全量复制后主从会保持连接，主库产生的写命令会通过连接同步给从库

同步开始的从库操作

- 关闭嵌套从库连接，清理从库保持的复制缓冲区
- 接收主库RDB数据：建立从库的 RDB，读取主库 RDB 数据，写入从库 RDB
- 清空从库数据，暂时停止从主库接收数据，将 RDB 数据加载到从库
- 将fullresync中的 runId和复制缓存替换从库自己保持的
- 从库重新开始接收主库数据
- 打开从库嵌套从库，开始嵌套从库的全量复制

### 主从库断连怎么办

主库有一个复制缓冲区，处理写命令同时会将写命令同步一份到复制缓冲区，当主从断开重连后，只要从库的复制点还在复制缓冲区，可以从之前的复制点进行同步。

这个缓冲区是一个环形结构，开始时主次均在同一起点，如果同步正常，同步完成后，主从位置也会相同；断连后，主库依旧会将写命令到缓冲区，当缓冲区空间用完，由于环形结构，主库同步写命令不会停止，而是会覆盖旧的写命令，因此当断连时间较长时，就会出现从库的复制点被覆盖的问题，这时就会触发全量复制。

另外，如果有突发请求，导致写命令速度大于同步速度，也会导致缓冲区空间用完，触发全量复制，这种情况可以通过增加缓冲区空间大小解决，通常可以将缓冲区空间大小设置为正确请求所需空间的两倍

