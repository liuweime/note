# SQL 的执行过程

MySQL 大致可以分成Server层与引擎层，，Server层涵盖了MySQL大部分核心功能，词法分析、执行优化都是在Server层完成，存储过程、触发器、视图等功能均在Server层实现，包括连接器、查询缓存、分析器、优化器、执行器等；引擎层主要负责数据的存储和提取。

### 连接器

连接器负责与客户端建立连接、维持管理连接、获取权限。在账号密码验证通过后，连接器会查询出该用户的权限，该连接后续操作均依赖与该权限（也就是说在该连接为断开前，即使此时对该用户权限做了修改，也不影响当前操作）。

注意，虽然连接器获取到权限，但是不会在此验证权限，需要等待到执行器中进行判断。这是因为连接器中MySQL还不知道要设计哪些表（未经分析器分析），也不能在优化器前判断，因为某些表可能需要等到执行中才能确认（如触发器）。

**长连接与短连接**

> 未完待续


### 查询缓存

通过连接器后，MySQL会在查询缓存中查看要执行的SQL是不是在缓存中存在，如果命中就会直接返回结果。事实上，查询缓存是一个鸡肋，仅在少数场景中可以被用到。

这是因为查询缓存的失效非常频繁，只要表有更新，这个表的查询缓存就会被清除，因此查询缓存的命中率非常低，只有长时间不更新的表才会有使用机会，因此通过建议将查询缓存关闭，在MySQL8中更是已经将该功能移除。

### 分析器

执行一个SQL，MySQL必须知道它的具体要干啥，分析器的作用就是解析SQL，识别SQL动作，通常`You have an error in your SQL syntax`错误就是在分析器中报出。

分析器保护词法分析和语法分析，词法分析是分析SQL语句中字符串的含义，判断是查那个表、哪个列，并判断表、列是否存在等，语法分析用于分析该SQL是否符合MySQL的语法。

### 优化器

优化器的作用是从多个执行方案中选择一个执行效率较高的方案（可能不是最佳方案），例如使用那个索引，表的连接顺序等。

在查询优化器中通常经过四个阶段：

- **逻辑转换**：该阶段主要完成等值传递、常量表达式计算、外连接转内连接等
- **优化准备**：
- **基于成本优化**：访问方法，连接方式选择
- **优化方案改进**：表条件下推、索引下推

通过 `EXPLAIN` 和`show WARNINGS`命令，可以看到经过优化后的SQL语句，通过`SET optimizer_trace="enabled=on"`并执行`select * from information_schema.optimizer_trace;`可以看到优化器的执行过程。

如下面SQL：

```sql
EXPLAIN
SELECT * FROM t_user WHERE 1=1 AND a = 2 AND a=b;
SHOW WARNINGS; 
```


优化后SQL：

```sql
/* select#1 */ select `test`.`t_user`.`id` AS `id`,`test`.`t_user`.`name` AS `name`,`test`.`t_user`.`age` AS `age`,`test`.`t_user`.`sex` AS `sex`,`test`.`t_user`.`is_deleted` AS `is_deleted`,`test`.`t_user`.`created_time` AS `created_time`,`test`.`t_user`.`updated_time` AS `updated_time`,`test`.`t_user`.`a` AS `a`,`test`.`t_user`.`b` AS `b` from `test`.`t_user` where ((`test`.`t_user`.`a` = 2) and (`test`.`t_user`.`b` = 2))
```


可以看到`a=b`经过等值传递被优化为`b=2`

优化器是基于成本进行的优化，所选的方案因此可能不是最佳方案。

此外，为了找到最佳方案，优化器会对比不同的查询方案，随着关联表的增加，各表不同的关联顺序及其表中的索引访问不同，会导致执行方案倍增，最终可能会出现选择方案的时间比执行方案时间长的情况。因此，建议查询SQL较少关联表。

其他更为详细优化器的内容请看参考链接。

### 执行器

优化器优化后的执行方案被送到执行器中执行，调用存储引擎接口获取数据

### 总结

综上：

**一个查询SQL在MySQL中执行：**

- 首先客户端通过连接器与MySQL连接，进行权限验证；
- 如果MySQL没有禁用缓存功能，那么会在缓存中判断是否有查询的SQL，如果有就直接返回
- 如果禁用缓存或缓存中无该查询，那么该SQL会进分析器中，对SQL进行词法分享、语法分析
- 完成分析后，会进入优化器，在优化器中生成一个执行方案
- 在执行器中拿到优化器的执行方案，MySQL会按照定义调用相关引擎获取相关数据

**一个插入/更新SQL在MySQL中的执行过程：**

事实上，查询SQL所经历的执行过程也需要在更新SQL中再来一遍，不过进入执行器后更新流程涉及到MySQL的两个重要日志 `Redo log`和 `Bin log`。



> 参考链接

[https://zhuanlan.zhihu.com/p/192707721](https://zhuanlan.zhihu.com/p/192707721)