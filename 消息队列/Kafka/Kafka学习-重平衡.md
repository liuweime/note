# Kafka 学习 | 重平衡

基本上说的消费者组都会提到消费者组的重平衡机制，现在来了解一下重平衡机制、触发条件及其影响。

### 重平衡机制

Kafka 消费者组中有多个消费者，订阅多个分区消费，为保证好的性能，必然需要让每个消费者分配到的分区数量一致，避免有些实例消费不完，有些实例空闲。那么保证消费组中实例保存分区一致，会存在一个分配的过程，这个就是重平衡。

### 触发条件

重分配涉及消费者实例数量和分区数量，那么其中有一个发现变化都会触发重平衡发生：

- 有新的消费者加入消费者或有消费者离开消费组
- 消费者订阅的 Topic 数量发生变化
- 消费者订阅的 Topic 下 Partition 的数量发生变化

### 重平衡分配策略

**Range**

Range 分配策略是基于主题进行分配的，如果 Topic1 下有三个分区，Topic2 下游两个分区，消费者组中有两个消费者，那么必然会出现有一个消费者消费了 Topic1 的两个分区、Topic2 的一个分区。

该种分配方法因为是基于 Topic 的，所以不是绝对的平均

**RoundRobin**

这个分配策略是轮询方式，会将所有分区按照字典排序轮询分配给消费者。

如果消费者者订阅了所有分区，该分配方法是均匀的；如果消费者订阅的分区不一致，那么会出现分配不均匀的情况

**StickyAssignor**

当使用前两种分配策略时，如果发生重平衡，可能会导致当前消费者订阅的分区，被分配给了其他消费者；而使用 StickyAssignor 后，在分配时会尽可能与上次分配的相同

### 造成影响

在重平衡期间，所有消费实例均停止工作，等重平衡完成；同时重平衡比较慢，根据消费实例数量和分区数量，重平衡持续时间有正相关。

因此发送重平衡会导致消费延迟、积压，在生产中需要尽量避免重平衡发生。

### 如何避免不必要的重平衡

重平衡的弊端暂时无法解决，那么就需要尽量避免不必要的重平衡。

根据上面了解的重平衡发生的条件，无论是 Topic 数量变化还是 Partition 数量变化，一般都是进过运维的，在可预期范围内。

所以，我们控制的是异常消费者实例离开消费组。那么，哪些情况下消费者会被剔除消费组呢：

- 1、心跳检测，如果某个消费者未及时发送心跳包，就会被认为是挂掉，被剔除消费组，心跳检测的参数是`session.timeout.ms` 和 `heartbeat.interval.ms`
- 2、消费间隔过长，如果消费实例两次消费之间的时间间隔超过设置的值，也会被剔除消费组，这个参数是 `max.poll.interval.ms`

根据上面两点优化参数配置，就可以较为有效的减少重平衡发生：

- 根据网上提供参数，`session.timeout.ms=6000` 和 `heartbeat.interval.ms=2000`较好
- `max.poll.interval.ms` 需要配置的比一次消费的时间大一些



### 参考

[详细解析kafka之 kafka消费者组与重平衡机制](https://www.cnblogs.com/listenfwind/p/12662968.html)

[Kafka 分区分配策略](https://cdrcool.github.io/2020/01/24/Kafka%E5%88%86%E5%8C%BA%E5%88%86%E9%85%8D%E7%AD%96%E7%95%A5/)